package dev.weekend.slashcommand.presentation.model

import dev.weekend.slashcommand.application.model.LunchActionSummary
import dev.weekend.slashcommand.domain.constant.LunchConstant.CONFIRM_LIST
import dev.weekend.slashcommand.domain.constant.LunchConstant.HAPPY_EMOJIS
import dev.weekend.slashcommand.domain.constant.LunchConstant.RESET_EMOJIS
import dev.weekend.slashcommand.domain.constant.LunchConstant.SAD_EMOJIS
import dev.weekend.slashcommand.domain.entity.LunchItem
import dev.weekend.slashcommand.domain.enums.DoorayButtonStyle.PRIMARY
import dev.weekend.slashcommand.domain.enums.DoorayResponseType.EPHEMERAL
import dev.weekend.slashcommand.domain.enums.DoorayResponseType.IN_CHANNEL
import dev.weekend.slashcommand.domain.enums.LunchInteractionType
import dev.weekend.slashcommand.domain.enums.LunchItemType
import dev.weekend.slashcommand.domain.extension.getRandom
import dev.weekend.slashcommand.domain.extension.toJson
import dev.weekend.slashcommand.domain.model.DoorayAction
import dev.weekend.slashcommand.domain.model.DoorayAttachment

/**
 * @author Yoohwa Cho
 */
data class LunchCommandResponse(
    val text: String,
    val responseType: String? = null,
    val replaceOriginal: Boolean? = null,
    val deleteOriginal: Boolean? = null,
    val attachments: List<DoorayAttachment>? = null,
    val channelId: String? = null,
    val creatorId: Long? = null,
) {
    companion object {
        fun createLunchStartFormBy() = LunchCommandResponse(
            text = "Ïò§ÎäòÏùò Ï†êÏã¨ Î©îÎâ¥Îäî? üòÆ",
            responseType = EPHEMERAL.value,
            attachments = listOf(
                DoorayAttachment(
                    actions = listOfNotNull(
                        DoorayAction.createButton(
                            name = LunchInteractionType.START,
                            text = "ÌòºÏûê Í≥†Î•ºÎûòÏöî üë§",
                            value = LunchActionSummary.createBy(EPHEMERAL).toJson()
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.START,
                            text = "Í∞ôÏù¥ Í≥†Î•ºÎûòÏöî üë•",
                            value = LunchActionSummary.createBy(IN_CHANNEL).toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.HELP,
                            text = "ÎçîÎ≥¥Í∏∞ üîç",
                            value = LunchActionSummary.createBy(EPHEMERAL).toJson(),
                        ),
                    )
                )
            )
        )

        fun createLunchFormBy(summary: LunchActionSummary) = LunchCommandResponse(
            text = "Ïò§ÎäòÏùò Ï†êÏã¨ Î©îÎâ¥Îäî? üòÆ",
            responseType = summary.responseType,
            deleteOriginal = if (summary.isInChannel()) true else null,
            attachments = listOf(
                DoorayAttachment(
                    actions = listOfNotNull(
                        DoorayAction.createButton(
                            name = LunchInteractionType.GET_RECOMMENDATION,
                            text = "ÎûúÎç§ÏúºÎ°ú Ï∂îÏ≤úÎ∞õÍ∏∞",
                            style = PRIMARY,
                            value = summary.toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.START_DETAIL_RECOMMEND,
                            text = "Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉùÌïòÍ∏∞",
                            value = summary.toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.CANCEL,
                            text = "Ï∑®ÏÜåÌïòÍ∏∞",
                            value = summary.toJson(),
                        ),
                    )
                )
            )
        )

        fun createLunchResultBy(item: LunchItem, summary: LunchActionSummary): LunchCommandResponse {
            return if (summary.isInChannel()) createPublicLunchResultBy(item, summary)
            else createPrivateLunchResultBy(item, summary)
        }

        //ÌòºÏûê Í≥†Î•¥Í∏∞ Ìï†Îïå Ï∂îÏ≤ú
        private fun createPrivateLunchResultBy(item: LunchItem, summary: LunchActionSummary) = LunchCommandResponse(
            text = "Ïò§Îäò Ï†êÏã¨ÏúºÎ°ú `${item.name}`(${item.type.label}) Ïñ¥Îñ†ÏÑ∏Ïöî?",
            responseType = summary.responseType,
            replaceOriginal = true,
            attachments = listOf(
                DoorayAttachment(
                    title = "${item.name} - Î©îÎâ¥ Î≥¥Îü¨Í∞ÄÍ∏∞",
                    titleLink = item.link,
                ),
                DoorayAttachment(
                    actions = listOfNotNull(
                        DoorayAction.createButton(
                            name = LunchInteractionType.CONFIRM_RECOMMEND,
                            text = "Í≥µÏú†ÌïòÍ∏∞ ${HAPPY_EMOJIS.getRandom()}",
                            value = summary.changeItemNo(item.no).toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.RECOMMEND_AGAIN,
                            text = "${if (summary.itemType.isNotBlank()) item.type.label + " " else ""}Îã§Ïãú ÎΩëÍ∏∞ ${
                                SAD_EMOJIS.getRandom()
                            }",
                            value = summary.toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.RESTART,
                            text = "Ï≤òÏùåÏúºÎ°ú ${RESET_EMOJIS.getRandom()}",
                            value = LunchActionSummary.createBy(summary.convertResponseType()).toJson()
                        ),
                    )
                )
            )
        )

        //Í∞ôÏù¥ Í≥†Î•¥Í∏∞ Ìï†Îïå Ï∂îÏ≤ú
        private fun createPublicLunchResultBy(item: LunchItem, summary: LunchActionSummary) = LunchCommandResponse(
            text = "Ïò§Îäò Ï†êÏã¨ÏúºÎ°ú `${item.name}`(${item.type.label}) Ïñ¥Îñ†ÏÑ∏Ïöî?",
            responseType = summary.responseType,
            replaceOriginal = true,
            attachments = listOf(
//                DoorayAttachment(
//                    actions = listOfNotNull(
//                        DoorayAction.createButton(
//                            name = LunchInteractionType.LIKE,
//                            text = "Ï¢ãÏïÑÏöî üëç",
//                            value = summary.likeItem().toJson()
//                        ),
//                        DoorayAction.createButton(
//                            name = LunchInteractionType.LIKE,
//                            text = "Ïã´Ïñ¥Ïöî üëé",
//                            value = summary.dislikeItem().toJson()
//                        ),
//                    )
//                ),
                DoorayAttachment(
                    title = "${item.name} - Î©îÎâ¥ Î≥¥Îü¨Í∞ÄÍ∏∞",
                    titleLink = item.link,
                ),
                DoorayAttachment(
                    actions = listOfNotNull(
                        DoorayAction.createButton(
                            name = LunchInteractionType.CONFIRM_RECOMMEND,
                            text = "ÌôïÏ†ïÌïòÍ∏∞ ${HAPPY_EMOJIS.getRandom()}",
                            value = summary.changeItemNo(item.no).toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.RECOMMEND_AGAIN,
                            text = "${if (summary.itemType.isNotBlank()) item.type.label + " " else ""}Îã§Ïãú ÎΩëÍ∏∞ ${SAD_EMOJIS.getRandom()}",
                            value = summary.resetLike().toJson(),
                        ),
                        DoorayAction.createButton(
                            name = LunchInteractionType.RESTART,
                            text = "Ï≤òÏùåÏúºÎ°ú ${RESET_EMOJIS.getRandom()}",
                            value = LunchActionSummary.createBy(summary.convertResponseType()).toJson()
                        ),
                    )
                )
            )
        )

        fun createLunchDetailForm(summary: LunchActionSummary) = LunchCommandResponse(
            text = "Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.",
            responseType = summary.responseType,
            attachments = listOf(
                DoorayAttachment(
                    actions = LunchItemType.entries.map { lunchType ->
                        DoorayAction.createButton(
                            name = LunchInteractionType.GET_RECOMMENDATION,
                            text = "${lunchType.label} ${lunchType.getEmoji()}",
                            value = summary.changeItemType(lunchType).toJson(),
                        )
                    }
                ),
            ),
        )

        fun createLunchConfirmResult(item: LunchItem, summary: LunchActionSummary): LunchCommandResponse {
            return if (summary.isInChannel()) {
                createPublicLunchConfirmResult(item)
            } else createPrivateLunchConfirmResult(item)
        }

        //ÌòºÏûê Í≥†Î•¥Í∏∞ Ìï†Îïå Í≥µÏú†ÌïòÍ∏∞
        private fun createPrivateLunchConfirmResult(item: LunchItem) = LunchCommandResponse(
            text = "Ïò§Îäò Ï†êÏã¨ÏúºÎ°ú `${item.name}`(${item.type.label}) Ïñ¥Îñ†ÏÑ∏Ïöî? ü§î",
            responseType = IN_CHANNEL.value,
            deleteOriginal = true,
            attachments = listOf(
                DoorayAttachment(
                    title = "${item.name} - Î©îÎâ¥ Î≥¥Îü¨Í∞ÄÍ∏∞",
                    titleLink = item.link,
                ),
            )
        )

        //Í∞ôÏù¥ Í≥†Î•¥Í∏∞ Ìï†Îïå ÌôïÏ†ïÌïòÍ∏∞
        private fun createPublicLunchConfirmResult(item: LunchItem) = LunchCommandResponse(
            text = CONFIRM_LIST.shuffled().first(),
            responseType = IN_CHANNEL.value,
            deleteOriginal = true,
            attachments = listOf(
                DoorayAttachment(
                    title = "${item.name} - Î©îÎâ¥ Î≥¥Îü¨Í∞ÄÍ∏∞",
                    titleLink = item.link,
                ),
            )
        )

        fun createCancel(summary: LunchActionSummary) = LunchCommandResponse(
            text = "Îã§ÏùåÏóê Îã§Ïãú ÎßåÎÇòÏöî ${RESET_EMOJIS.getRandom()}",
            responseType = summary.responseType,
            deleteOriginal = true,
        )

        fun createHelp(summary: LunchActionSummary) = LunchCommandResponse(
            text = "Ïù¥Ïö©Ìï¥ Ï£ºÏÖîÏÑú Í∞êÏÇ¨Ìï©ÎãàÎã§ ${HAPPY_EMOJIS.getRandom()}",
            responseType = summary.responseType,
            attachments = listOf(
                DoorayAttachment(
                    title = "ÏãùÎãπ Ï†ÑÏ≤¥ Î™©Î°ù Î≥¥Îü¨Í∞ÄÍ∏∞ üìç",
                    titleLink = "https://naver.me/xRhSJQca",
                ),
                DoorayAttachment(
                    title = "Ïã†Í∑ú ÏãùÎãπ Ï∂îÍ∞Ä ÎòêÎäî ÌîºÎìúÎ∞± Ï†ÑÏÜ° üí≠",
                    titleLink = "https://forms.gle/Ewrzmg7dJiZxBeeJA",
                )
            )
        )
    }
}
